<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cucco Raid Overlay</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: transparent;
    }

    #cuccoContainer {
      position: relative;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

<div id="cuccoContainer"></div>

<script>
  const basePath = "../assets/cucco/";
  const numImages = 10;
  const raidDuration = 8000; // 8 seconds
  let raidStartTime = 0;
  let raidActive = false;

  // Asset paths (GIFs)
  const sprite1 = basePath + "cucco1.gif";
  const sprite2 = basePath + "cucco2.gif";
  const sound1 = basePath + "cucco1.wav"; // Intro sound
  const sound2 = basePath + "cucco2.wav"; // Looping ambient sound

  function random(min, max) {
    return Math.random() * (max - min) + min;
  }

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function initializeMovers() {
    const cuccoContainer = document.getElementById('cuccoContainer');
    const movers = [];

    for (let i = 0; i < numImages; i++) {
      for (let imgIndex = 0; imgIndex < 2; imgIndex++) {
        const img = document.createElement('img');
        img.src = imgIndex === 0 ? sprite1 : sprite2;
        img.style.position = 'absolute';
        img.style.width = '112px';
        img.style.height = 'auto';
        img.style.pointerEvents = 'none';

        // Random edge spawn
        let edge = randomInt(0, 3);
        let angle = random(Math.PI / 4, 3 * Math.PI / 4);
        let pos = { x: 0, y: 0 };
        let vel = { x: 0, y: 0 };
        let speed = random(1, 6);

        if (edge === 0) {
          pos.x = random(0, window.innerWidth);
          pos.y = 0;
          angle = random(Math.PI / 4, 3 * Math.PI / 4);
          vel.x = Math.cos(angle) * speed;
          vel.y = Math.sin(angle) * speed;
        } else if (edge === 1) {
          pos.x = window.innerWidth;
          pos.y = random(0, window.innerHeight);
          angle = random(Math.PI / 4, 3 * Math.PI / 4) + Math.PI / 2;
          vel.x = Math.cos(angle) * speed;
          vel.y = Math.sin(angle) * speed;
        } else if (edge === 2) {
          pos.x = random(0, window.innerWidth);
          pos.y = window.innerHeight;
          angle = random(Math.PI / 4, 3 * Math.PI / 4) + Math.PI;
          vel.x = Math.cos(angle) * speed;
          vel.y = Math.sin(angle) * speed;
        } else {
          pos.x = 0;
          pos.y = random(0, window.innerHeight);
          angle = random(Math.PI / 4, 3 * Math.PI / 4) + 3 * Math.PI / 2;
          vel.x = Math.cos(angle) * speed;
          vel.y = Math.sin(angle) * speed;
        }

        img.onload = () => {
          img.style.top = pos.y + 'px';
          img.style.left = pos.x + 'px';
          cuccoContainer.appendChild(img);
        };

        movers.push({ img, pos, vel });
      }
    }

    return movers;
  }

  function animate(movers) {
    function frame() {
      for (let mover of movers) {
        mover.pos.x += mover.vel.x;
        mover.pos.y += mover.vel.y;

        if (mover.pos.x > window.innerWidth) mover.pos.x -= window.innerWidth;
        if (mover.pos.x < 0) mover.pos.x += window.innerWidth;
        if (mover.pos.y > window.innerHeight) mover.pos.y -= window.innerHeight;
        if (mover.pos.y < 0) mover.pos.y += window.innerHeight;

        mover.img.style.left = mover.pos.x + 'px';
        mover.img.style.top = mover.pos.y + 'px';
        mover.img.style.transform = mover.vel.x < 0 ? 'scaleX(-1)' : 'scaleX(1)';
      }

      requestAnimationFrame(frame);
    }

    requestAnimationFrame(frame);
  }

  function playIntroSound(soundSrc) {
    const introSound = new Audio(soundSrc);
    introSound.volume = 0.8;
    introSound.playbackRate = 1.0;

    introSound.play().catch(e => {
      console.error("Error playing intro audio:", e);
    });

    introSound.onended = () => {
      playAmbientSound();
    };
  }

  function playAmbientSound() {
    const ambientSound = new Audio(sound2);
    ambientSound.volume = random(0.5, 1.0);
    ambientSound.playbackRate = random(0.9, 1.15);

    ambientSound.play().catch(e => {
      console.error("Error playing ambient audio:", e);
    });

    ambientSound.onended = () => {
      if (!raidActive) return;

      const delay = random(300, 1000);
      setTimeout(() => {
        playAmbientSound();
      }, delay);
    };
  }

  function startCuccoRaid() {
    if (raidActive) return;

    raidActive = true;
    raidStartTime = Date.now();

    const movers = initializeMovers();
    animate(movers);
    playIntroSound(sound1);

    // Stop everything after 8 seconds
    setTimeout(() => {
      stopCuccoRaid();
    }, raidDuration);
  }

  function stopCuccoRaid() {
    raidActive = false;

    document.getElementById('cuccoContainer').innerHTML = '';
    document.body.style.display = 'none';
  }

  // Listen for postMessage from index.html
  window.addEventListener('message', function(event) {
    try {
      const msg = event.data;

      if (msg.overlay !== 'cucco') return;

      if (msg.show) {
        document.body.style.display = 'block';
        startCuccoRaid();
      } else {
        stopCuccoRaid();
      }

    } catch (e) {
      stopCuccoRaid();
    }
  });
</script>

</body>
</html>