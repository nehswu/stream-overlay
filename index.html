<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Modular Overlay System</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: transparent;
    }

    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

<div id="overlayContainer"></div>
<div id="placeholder" style="display: block;">No overlay active</div>

<script>
  const overlayMap = {
    'mic': 'overlays/mic-mute.html',
    'runners': 'overlays/runners.html',
    'cucco': 'overlays/cucco.html'
  };

  const loadedOverlays = {};
  const messageQueue = {}; // Hold messages until overlay is ready

  function sendOverlayMessage(name, message) {
    if (!loadedOverlays[name]) {
      console.warn(`[index.html] Can't send to ${name} - iframe not created`);
      return;
    }

    if (!loadedOverlays[name].isReady) {
      console.log(`[index.html] Queueing message for ${name}:`, message);
      if (!messageQueue[name]) messageQueue[name] = [];
      messageQueue[name].push(message);
      return;
    }

    try {
      console.log(`[index.html] Sending to ${name}:`, message);
      loadedOverlays[name].contentWindow.postMessage(message, '*');
    } catch (e) {
      console.error(`[index.html] Failed to send to ${name}:`, e.message);
    }
  }

  function preloadOverlay(name) {
    const iframe = document.createElement('iframe');
    iframe.id = `overlay-${name}`;
    iframe.name = name;
    iframe.src = overlayMap[name];
    iframe.style.zIndex = 1000 + Object.keys(loadedOverlays).length;

    iframe.onload = () => {
      console.log(`[index.html] Overlay iframe loaded: ${name}`);
      loadedOverlays[name] = iframe;
      loadedOverlays[name].isReady = false; // Not yet ready
      document.body.appendChild(iframe);
    };
  }

  window.addEventListener('DOMContentLoaded', () => {
    Object.keys(overlayMap).forEach(preloadOverlay);
  });

  // Listen for overlay ready signals
  window.addEventListener('message', function(event) {
    const msg = event.data;
    const name = msg.overlay;

    if (msg.ready === true && loadedOverlays[name]) {
      console.log(`[index.html] Overlay ready: ${name}`);
      loadedOverlays[name].isReady = true;

      // Replay queued messages
      if (messageQueue[name]) {
        console.log(`[index.html] Replaying ${messageQueue[name].length} queued messages for ${name}`);
        messageQueue[name].forEach(msg => {
          sendOverlayMessage(name, msg);
        });
        messageQueue[name] = []; // Clear queue
      }
    }
  });

  // WebSocket setup
  const ws = new WebSocket('ws://localhost:3000');

  ws.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      const overlaysToShow = Array.isArray(data.show) ? data.show : [];

      console.log("[index.html] Received trigger:", data);

      // Send to each overlay
      Object.keys(overlayMap).forEach(name => {
        const show = overlaysToShow.includes(name);
        const payload = {
          overlay: name,
          show: show,
          data: data.data?.[name] || null
        };

        sendOverlayMessage(name, payload);
      });

    } catch (e) {
      console.error("Error parsing WebSocket message", e);
    }
  };

  ws.onopen = () => {
    console.log("[index.html] WebSocket connected");
  };
</script>

</body>
</html>